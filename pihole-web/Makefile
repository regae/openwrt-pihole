include $(TOPDIR)/rules.mk

PKG_NAME:=pihole-web
PKG_VERSION:=5.12
PKG_RELEASE:=1

PKG_SOURCE_URL:=https://codeload.github.com/pi-hole/AdminLTE/tar.gz/v$(PKG_VERSION)?
PKG_SOURCE:=$(PKG_NAME)-$(PKG_VERSION).tar.gz
PKG_HASH:=c770daaf5360c659ab3b9c07a118f0170307dd1e7857ece5d02ef5e3f1ead057
PKG_BUILD_DIR:=$(BUILD_DIR)/AdminLTE-$(PKG_VERSION)

PKG_LICENSE:=EUPL
PKG_LICENSE_FILES:=LICENSE

include $(INCLUDE_DIR)/package.mk

define Package/pihole-web
  SECTION:=regae
  CATEGORY:=regae
  TITLE:=Pi-hole Dashboard for stats and more
  URL:=https://pi-hole.net/
  DEPENDS:=pihole +lighttpd +lighttpd-mod-access +lighttpd-mod-fastcgi +lighttpd-mod-setenv +php8 +php8-cgi +php8-cli +php8-mod-openssl +php8-mod-phar +php8-mod-session +php8-mod-sqlite3 +php8-mod-intl +php8-mod-xml +php8-mod-filter +zoneinfo-asia
endef

define Package/pihole-web/description
  Pi-hole®'s Web interface (based off of AdminLTE) provides a central location to manage your Pi-hole and review the statistics generated by FTLDNS™.
endef

define Build/Compile
endef

#	$(INSTALL_DIR) $(1)/etc/sudoers.d
#	$(INSTALL_DATA) ./files/pihole.sudo $(1)/etc/sudoers.d/pihole
define Package/pihole-web/install
	$(INSTALL_DIR) $(1)/etc/lighttpd/conf.d
	$(INSTALL_DATA) ./files/pihole-lighttpd.conf $(1)/etc/lighttpd/conf.d/99-pihole.conf
	$(INSTALL_DIR) $(1)/srv/www
	$(INSTALL_DIR) $(1)/srv/www/admin
	$(CP) -r $(PKG_BUILD_DIR)/{img,scripts,style,*.php} $(1)/srv/www/admin/
	$(RM) -f $(1)/srv/www/admin/debug.php
	$(RM) -f $(1)/srv/www/admin/scripts/pi-hole/js/debug.js
	$(RM) -f $(1)/srv/www/admin/scripts/pi-hole/php/debug.php
	$(INSTALL_DIR) $(1)/srv/www/pihole
	$(INSTALL_DATA) ./files/blockingpage.css $(1)/srv/www/pihole/
	$(INSTALL_DATA) ./files/index.php $(1)/srv/www/pihole/
	$(INSTALL_DIR) $(1)/usr/share/acl.d
	$(INSTALL_DATA) ./files/pihole_web.json $(1)/usr/share/acl.d
endef

define Package/pihole-web/postinst
#!/bin/sh
# check if we are on real system
if [ -z "$${IPKG_INSTROOT}" ]; then
	sed -i '/doc_root/ s/^;*/;/' /etc/php.ini
fi
exit 0
endef

$(eval $(call BuildPackage,pihole-web))
